### 외래키
---
InnoDB의 외래키 관리에는 중요한 두 가지 특징이 있다.

- 테이블의 변경(쓰기 잠금)이 발생하는 경우에만 잠금 경합(잠금 대기)이 발생한다.
- 외래키와 연관되지 않은 컬럼의 변경은 최대한 잠금 경합(잠금 대기)을 발생시키지 않는다.

### 자식 테이블의 변경이 대기하는 경우
---
```sql
begin;
update tb_parent set fd = 'changed-2' where id = 2;

-> begin;
-> update tb_child set pid = 2 where id = 100;

rollback;

-> Query OK, 1 row affected(3.04sec)

```
부모 테이블에서 id가 2인 레코드에 `update`를 실행한다. 이 과정에서 1번 커넥션이 id가 2인 레코드에 대해 쓰기 잠금을 획득한다.
2번 커넥션에서 외래키 컬럼을 변경하는 작업은 부모 테이블의 변경 작업이 완료될 때까지 대긴한다.

자식 테이블의 외래 키 칼럼의 변경은 부모 테이블의 확인이 필요하다. 이 상태에서 부모 테이블의 해당 레코드가 쓰기 잠금이 걸려 있으면 해당 쓰기 잠금이 해제될 때까지 기다리게 된다.
자식 테이블의 외래키가 아닌 컬럼의 변경은 외래키로 인한 잠금 확장이 발생하지 않는다.

### 부모 테이블의 변경 작업이 대기하는 경우
---
```sql
begin;
update tb_child set fd = 'changed-100' where id 100;

-> begin;
-> delete from tb_parent where id = 1;

rollback;

-> Query OK, 1 row affected(3.04sec)
```
1번 커넥션에서 부모 테이블 id `1`을 참조하는 자식 테이블의 레코드를 변경하면 tb_child 테이블의 레코드에 대해 쓰기 잠금을 획득한다. 
2번 커넥션에서 tb_parent 테이블의 id가 1인 레코드를 삭제하는 경우 자식 테이블의 레코드에 대한 쓰기 잠금이 해제될 때까지 기다려야 한다.

물리적으로 외래키를 생성하면 자식 테이블에 레코드가 추가되는 경우 해당 참조키가 부모 테이블에 있는지 확인한다. 물리적인 외래키의 고려 사항은 이러한 체크를 위해 연관 테이블에 읽기 잠금을 걸어야 한다. 이렇게 잠금이 다른 테이블로 확장되면 그만큼 전체적으로 쿼리의 동시 처리에 영향을 미친다.