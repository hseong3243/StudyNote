#### 트랜잭션 전파(propagation)
---
트랜잭션 전파는 스프링에서 이미 트랜잭션이 진행중인 상태에서 새로운 트랜잭션을 수행하는 경우 어떻게 동작할지를 결정하는 것입니다.
![[논리 트랜잭션.png]]

스프링은 물리 트랜잭션과 논리 트랜잭션을 나누어 전파를 설명합니다. 물리 트랜잭션은 실제 데이터베이스에 적용되는 트랜잭션을 뜻합니다. 논리 트랜잭션은 트랜잭션 매니저를 통해 트랜잭션을 사용하는 단위입니다.

진행중인 트랜잭션에 참여하는 논리 트랜잭션들은 모두 커밋되어야 물리 트랜잭션이 커밋됩니다. 하나라도 롤백되면 물리 트랜잭션은 롤백됩니다.

여러 트랜잭션이 함께 사용되는 경우 처음 트랜잭션을 시작한 외부 트랜잭션이 실제 물리 트랜잭션을 관리합니다. 

#### 트랜잭션 전파 흐름
---
##### REQUIRED
외부 트랜잭션이 시작되면 트랜잭션 매니저를 통해 커넥션을 획득하고 트랜잭션 동기화 매니저에 커넥션을 보관합니다. 내부 트랜잭션이 시작되면 트랜잭션 매니저는 기존 트랜잭션 존재를 확인하고 트랜잭션에 참여합니다. 

트랜잭션 매니저는 트랜잭션을 생성한 결과를 `TransactionStatus`에 담아서 반환하며 이를 통해 신규 트랜잭션 여부를 확인할 수 있습니다. 

내부 트랜잭션이 종료되면 신규 트랜잭션이 아니기 때문에 커밋을 호출하지 않습니다. 외부 트랜잭션은 신규 트랜잭션이기 때문에 커밋을 호출하고 물리 트랜잭션을 종료합니다.

만일 트랜잭션 중 하나에 롤백이 발생하는 경우 외부 트랜잭션은 곧바로 롤백을 진행하지만 내부 트랜잭션에서 롤백이 발생하는 경우에는 조금 다르게 작동합니다. 내부 트랜잭션은 트랜잭션 롤백 대신 트랜잭션 동기화 매니저에 `rollbackOnly=true`라는 표시를 해둡니다.

외부 트랜잭션은 트랜잭션 동기화 매니저에 `rollbackOnly`를 확인하고 물리 트랜잭션을 롤백합니다.
##### REQUIRES_NEW
`REQUIRES_NEW`는 기존에 진행중인 트랜잭션이 있어도 참여하지 않고 항상 새로운 트랜잭션을 시작합니다. 때문에 기존 트랜잭션과 신규 트랜잭션의 커밋, 롤백 여부는 서로 영향을 주지 않습니다.

#### 전파 옵션
---
##### REQUIRED
기본 옵션입니다. 트랜잭션이 없으면 생성하고 있으면 참여합니다.
##### REQUIRES_NEW
항상 새로운 트랜잭션을 생성합니다.
##### SUPPORT
기존 트랜잭션이 없으면 트랜잭션 없이 진행하고 있으면 참여합니다.
##### NOT_SUPPORT
트랜잭션 없이 진행합니다.
##### MANDATORY
트랜잭션이 반드시 존재해야 합니다. 없으면 예외가 발생합니다.
##### NEVER
기존 트랜잭션이 있으면 예외가 발생합니다. 없으면 진행합니다.
##### NESTED
트랜잭션이 없으면 새롭게 생성하고 있으면 중첩 트랜잭션을 생성합니다. 중첩 트랜잭션은 외부에 영향을 주지 않지만 외부로부터의 영향을 받습니다.

`isolation`, `timeout`, `readOnly`는 트랜잭션이 처음 시작될 때만 적용됩니다.

## 참고
---
김영한님의 스프링 DB